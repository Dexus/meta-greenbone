From 61683807a9a0ed39e4cd4fbc0b52c5b25f21f3cb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Josef=20Fr=C3=B6hle?= <github@josef-froehle.de>
Date: Sun, 6 Nov 2022 14:28:25 +0100
Subject: [PATCH] fix build and use pkg-config for libgcrypt

---
 src/CMakeLists.txt | 35 ++++++++++++++++++++++-------------
 1 file changed, 22 insertions(+), 13 deletions(-)

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 6b27cd9a3..b1af5adc2 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -32,29 +32,38 @@ pkg_check_modules (LIBGVM_GMP REQUIRED libgvm_gmp>=10.0.0)
 pkg_check_modules (GNUTLS REQUIRED gnutls>=3.2.15)
 
 message (STATUS "Looking for libgcrypt...")
-find_library (LIBGCRYPT gcrypt)
-if (NOT LIBGCRYPT)
-  message (SEND_ERROR "The libgcrypt library is required.")
-else (NOT LIBGCRYPT)
+pkg_check_modules (LIBGCRYPT gcrypt)
+message (STATUS "Looking for libgcrypt... ${LIBGCRYPT}")
+if (NOT LIBGCRYPT_FOUND)
+  pkg_check_modules (LIBGCRYPT libgcrypt)
   message (STATUS "Looking for libgcrypt... ${LIBGCRYPT}")
-  execute_process (COMMAND libgcrypt-config --libs
-    OUTPUT_VARIABLE LIBGCRYPT_LDFLAGS
-    OUTPUT_STRIP_TRAILING_WHITESPACE)
-  execute_process (COMMAND libgcrypt-config --cflags
-    OUTPUT_VARIABLE LIBGCRYPT_CFLAGS
-    OUTPUT_STRIP_TRAILING_WHITESPACE)
-endif (NOT LIBGCRYPT)
+  message (STATUS "Found libgcrypt...? ${LIBGCRYPT_FOUND}")
+  if (NOT LIBGCRYPT_FOUND)
+    find_library (LIBGCRYPT gcrypt)
+    if (NOT LIBGCRYPT)
+      message (SEND_ERROR "The libgcrypt library is required.")
+    else (NOT LIBGCRYPT)
+      message (STATUS "Looking for libgcrypt... ${LIBGCRYPT}")
+      execute_process (COMMAND libgcrypt-config --libs
+        OUTPUT_VARIABLE LIBGCRYPT_LDFLAGS
+        OUTPUT_STRIP_TRAILING_WHITESPACE)
+      execute_process (COMMAND libgcrypt-config --cflags
+        OUTPUT_VARIABLE LIBGCRYPT_CFLAGS
+        OUTPUT_STRIP_TRAILING_WHITESPACE)
+    endif (NOT LIBGCRYPT)
+  endif (NOT LIBGCRYPT_FOUND)
+endif (NOT LIBGCRYPT_FOUND)
 
 if (NOT LIBMICROHTTPD_FOUND OR NOT LIBXML_FOUND OR NOT GLIB_FOUND OR
     (GTHREAD_REQUIRED AND NOT GTHREAD_FOUND) OR NOT
     LIBGVM_GMP_FOUND OR NOT GNUTLS_FOUND OR NOT
-    LIBGCRYPT)
+    LIBGCRYPT_FOUND)
   message (FATAL_ERROR "One or more required libraries was not found "
     "(see message above), please install the missing "
     "libraries and run cmake again.")
 endif (NOT LIBMICROHTTPD_FOUND OR NOT LIBXML_FOUND OR NOT GLIB_FOUND OR
   (GTHREAD_REQUIRED AND NOT GTHREAD_FOUND) OR NOT
-  LIBGVM_GMP_FOUND OR NOT GNUTLS_FOUND OR NOT LIBGCRYPT)
+  LIBGVM_GMP_FOUND OR NOT GNUTLS_FOUND OR NOT LIBGCRYPT_FOUND)
 
 ## Program
 
